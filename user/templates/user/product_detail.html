{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mx-auto py-8">
  <nav class="text-sm text-gray-600 mb-6">
    <a href="/" class="hover:text-blue-600">Home</a> /
    <a href="{% url 'shop' %}" class="hover:text-blue-600">Shop</a> /
    <span class="text-gray-900 font-semibold">{{ product.name }}</span>
  </nav>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-10 border rounded-xl p-6 bg-white">
    <div>
      <div class="relative overflow-hidden rounded-xl border">
        <button id="prevBtn"
          class="absolute left-3 top-1/2 -translate-y-1/2 bg-black/40 text-white px-3 py-2 rounded-full">‹</button>

        {% if product.images.first %}
        <img id="mainImage"
             src="{{ product.images.first.image.url }}"
             class="w-full h-96 object-cover transition-transform duration-300"
             alt="{{ product.name }}">
        {% endif %}

        <button id="nextBtn"
          class="absolute right-3 top-1/2 -translate-y-1/2 bg-black/40 text-white px-3 py-2 rounded-full">›</button>
      </div>

      <div class="flex gap-3 mt-4 overflow-x-auto">
        {% for img in product.images.all %}
          <img src="{{ img.image.url }}"
               class="thumb w-20 h-20 object-cover rounded border cursor-pointer hover:ring-2 hover:ring-blue-500">
        {% endfor %}
      </div>
    </div>
    <div class="space-y-4">

      <h1 class="text-3xl font-bold text-gray-800">{{ product.name }}</h1>
      <div class="flex items-center gap-2">
        <div class="text-yellow-400 text-xl">★★★★☆</div>
        <p class="text-gray-500 text-sm">(23 reviews)</p>
      </div>
      <div>
        <p class="text-2xl font-bold text-green-700">
          ₹{{ product.discount_price|default:product.price }}
        </p>
        {% if product.discount_price %}
          <p class="text-gray-500 line-through">₹{{ product.price }}</p>
        {% endif %}
      </div>
      <form method="POST" action="{% url 'add_to_cart' %}" class="space-y-4 pt-4">
        {% csrf_token %}
        <input type="hidden" name="product_id" value="{{ product.id }}">
        <div>
          <label class="block font-semibold mb-2">Select Color</label>
          <select name="variant_id"
                  required
                  class="border rounded px-3 py-2 w-full">

            <option value="">Select Color</option>

            {% for cv in product.colors.all %}
              <option value="{{ cv.id }}"
                {% if cv.stock == 0 %}disabled{% endif %}>

                {{ cv.color }}
                {% if cv.stock > 0 %}
                  (In Stock: {{ cv.stock }})
                {% else %}
                  (Out of stock)
                {% endif %}

              </option>
            {% endfor %}

          </select>
        </div>

        <div>
          <label class="block font-semibold mb-2">Quantity</label>
          <input type="number"
                 name="quantity"
                 value="1"
                 min="1"
                 max="5"
                 class="border rounded px-3 py-2 w-24">
        </div>

        <button type="submit"
          class="w-full bg-black text-white py-3 rounded hover:bg-gray-800 transition">
          Add to Cart
        </button>
      </form>

      <button class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 w-full">
        Buy Now
      </button>

    </div>
  </div>

  <div class="mt-10 border rounded-xl bg-white p-6">
    <div class="flex gap-8 border-b mb-4">
      <button id="tabDesc"
              class="font-semibold text-blue-700 border-b-2 border-blue-700 pb-2">
        Description
      </button>
      <button id="tabReviews"
              class="text-gray-600 hover:text-blue-600 pb-2">
        Reviews
      </button>
    </div>

    <div id="descContent">
      <p class="text-gray-700 leading-relaxed">
        {{ product.description }}
      </p>
    </div>

    <div id="reviewContent" class="hidden space-y-4">
      <div class="p-4 bg-gray-50 rounded border">
        <div class="flex justify-between">
          <strong>John D.</strong>
          <span class="text-yellow-400">★★★★★</span>
        </div>
        <p class="text-gray-600 mt-2">
          Excellent quality and balance!
        </p>
      </div>

      <div class="p-4 bg-gray-50 rounded border">
        <div class="flex justify-between">
          <strong>Rahul K.</strong>
          <span class="text-yellow-400">★★★★☆</span>
        </div>
        <p class="text-gray-600 mt-2">
          Worth the price.
        </p>
      </div>
    </div>
  </div>

  <!-- RELATED PRODUCTS -->
  <div class="mt-14">
    <h2 class="text-2xl font-bold mb-6">Related Products</h2>

    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
      {% for rp in related_products %}
      <a href="{% url 'product_detail' rp.id %}"
         class="border rounded-xl p-4 bg-white hover:shadow-md transition">

        {% if rp.images.first %}
        <img src="{{ rp.images.first.image.url }}"
             class="w-full h-40 object-cover rounded-lg">
        {% endif %}

        <h3 class="mt-3 font-semibold text-gray-800 truncate">
          {{ rp.name }}
        </h3>

        <div class="flex items-center gap-1 text-yellow-400 text-sm mt-1">
          ★★★★☆
          <span class="text-gray-500">(18)</span>
        </div>

        <p class="text-green-700 font-bold mt-1">
          ₹{{ rp.discount_price|default:rp.price }}
        </p>
      </a>
      {% endfor %}
    </div>
  </div>

</div>

<!-- JS: Tabs + Slider + Zoom -->
<script>
const tabs = {
  tabDesc: "descContent",
  tabReviews: "reviewContent"
};

Object.keys(tabs).forEach(id => {
  document.getElementById(id).onclick = () => {
    Object.values(tabs).forEach(c =>
      document.getElementById(c).classList.add("hidden")
    );
    document.getElementById(tabs[id]).classList.remove("hidden");
  };
});

const thumbs = [...document.querySelectorAll(".thumb")];
const mainImage = document.getElementById("mainImage");
let index = 0;

thumbs.forEach((t, i) => t.onclick = () => {
  index = i;
  mainImage.src = t.src;
});

document.getElementById("prevBtn").onclick = () => {
  index = (index - 1 + thumbs.length) % thumbs.length;
  mainImage.src = thumbs[index].src;
};

document.getElementById("nextBtn").onclick = () => {
  index = (index + 1) % thumbs.length;
  mainImage.src = thumbs[index].src;
};

mainImage.addEventListener("mousemove", e => {
  const r = mainImage.getBoundingClientRect();
  mainImage.style.transformOrigin =
    `${((e.clientX - r.left)/r.width)*100}% ${((e.clientY - r.top)/r.height)*100}%`;
  mainImage.style.transform = "scale(2)";
});

mainImage.addEventListener("mouseleave", () => {
  mainImage.style.transform = "scale(1)";
});
</script>

{% endblock %}